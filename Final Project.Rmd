---
title: "Final Project"
author: "Brenda Yang, Charlie Bonetti, Nour Kanaan"
date: "7/19/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(gdata)
library(tidyverse)
library(sf)
library(readxl)
library(broom)
```

```{r data-variables, echo = FALSE}
dstate = read.xls("data/state depression rates 2020.xls")
astate = read.xls("data/State anxiety trends 2020.xls")
dtrends2020 = read.xls("data/April 2020 depression trends.xls")
dtrends2018 = read.xls("data/April 2018 depression trends.xls")
atrends2020 = read.xls("data/April 2020 anxiety trends.xls")
atrends2018 = read.xls("data/April 2018 anxiety trends.xls")
trends = read.xls("data/all_data.xls")
```

# Question 1: Does COVID have a significant effect on depression and anxiety levels in the US?

## "Depression" searches in April 2018 vs. April 2020
```{r depression-assumptions-2018, echo = FALSE}
ggplot(data = dtrends2018, mapping = aes(x = depression)) +
  geom_histogram(color = "snow3", fill = "mediumaquamarine", binwidth = 1)+ 
  labs(title = "depression searches by week in April 2020 are not normally distributed", 
       x = "depression searches", 
       y = "Number of weeks")
```
n<30 and not normal distribution: assumption for t-test not satisfied

```{r depression-assumptions-2020, echo = FALSE}
ggplot(data = dtrends2020, mapping = aes(x = depression)) +
  geom_histogram(color = "snow3", fill = "cadetblue3", binwidth = 1)+ 
  labs(title = "depression searches by week in April 2020 are not normally distributed", 
       x = "depression searches", 
       y = "number of weeeks")
```
n<30 and not normal distribution: assumption for t-test not satisfied

The assumptions for the two-sample t-test is not satisfied, so we decided use the Wilcox signed-rank test instead. 
```{r, depression-year-analysis, echo = FALSE}
d2020 <- dtrends2020 %>% 
  select(depression) %>% 
  pull()

d2018 <- dtrends2018 %>% 
  select(depression) %>% 
  pull()

wilcox.test(d2020, d2018, alternative = "two.sided",
            paired = TRUE,
            conf.level = .95)
```

The null hypothesis is that there is no difference in the median number of depression searches in the US between the times of April 2020 and April 2018. The alternate hypothesis is that there is a difference between the two means. Assuming that the null hypothesis is true, the model follows a z-distribution. The z-statistic is 5.5. This corresponds to a p-value of 1. We cannot reject the null at the alpha = 0.05 level. We do not have enough evidence to claim that there is a difference in the median amount of depression searches in the US between the times of April 2020 and April 2018.

## "Anxiety" searches in April 2018 vs. April 2020
```{r anxiety-assumptions-2018}
ggplot(data = atrends2018, mapping = aes(x = anxiety)) +
  geom_histogram(color = "snow3", fill = "cornflowerblue", binwidth = 1)+ 
  labs(title = "anxiety searches by week in April 2020 are normally distributed", 
       x = "anxiety searches", 
       y = "number of weeeks")
```
n<30, but has a normal distribution : assumption satisfied

```{r anxiety-assumptions-2020}
ggplot(data = atrends2020, mapping = aes(x = anxiety)) +
  geom_histogram(color = "snow3", fill = "lightsteelblue", binwidth = 1)+ 
  labs(title = "anxiety searches by week in April 2020 are not normally distributed", 
       x = "anxiety searches", 
       y = "number of weeeks")
```
n<30 and not normal distribution: assumption not satisfied

The assumptions are not satisfied, so we used the Wilcoxon signed test. 
```{r anxiety-year-analysis, echo = FALSE}
a2020 <- atrends2020 %>% 
  select(anxiety) %>% 
  pull()

a2018 <- atrends2018 %>% 
  select(anxiety) %>% 
  pull()

wilcox.test(a2020, a2018, alternative = "two.sided",
            paired = TRUE,
            conf.level = .95)
```
The null hypothesis is that there is no difference in the median amount of anxiety searches in the US between the times of April 2020 and April 2018. The alternate hypothesis is that there is a difference between the two medians. Assuming that the null hypothesis is true, the model follows a z-distribution. The z-statistic is 1. This corresponds to a p-value of 0.4227. We cannot reject the null at the alpha = 0.05 level. We do not have enough evidence to claim that there is a difference in the median amount of anxiety searches in the US between the times of April 2020 and April 2018. 

# Question 2: Does the level of COVID cases per US state have an effect on depression and anxiety levels?

## Association between "depression" searches and new COVID-19 cases per 100,000 residents in April 2020 
```{r depressionVScovid, echo = FALSE}
ggplot(trends, aes(New.COVID.cases.per.100.000.in.April, depression)) +
  geom_point(shape=1) +
   geom_smooth(method=lm) +
  labs(title = "No correlation", 
       x = "New COVID-19 cases (per 100,000) ", 
       y = "Google searches for depression (relative to state)" )
```
The above scatterplot shows the relative google searches for depression among the 50 American states as a function of new COVID-19 cases per 100,000 during the month of april, 2020.
The line of best fit (in blue) is horizontal with R = approximately zero. Thus, we cannot see any correlation between the new COVID-19 cases and the Google searches for depression for the month of April.

## COVID cases vs. depression rate
```{r set-covid-cat, echo = FALSE}
trends <- trends %>%
  mutate(case_cat = case_when(
    New.COVID.cases.per.100.000.in.April <= 91 ~ "low",
    New.COVID.cases.per.100.000.in.April > 91 & New.COVID.cases.per.100.000.in.April < 200 ~ "medium",
    New.COVID.cases.per.100.000.in.April >= 200 ~ "high"
  ))
```

```{r covid-depression-assumptions, echo = FALSE}
ggplot(data = trends, mapping = aes(x = depression)) +
  geom_histogram(color = "dodgerblue", fill = "lightsteelblue", binwidth = 4)+
  facet_grid(case_cat~.) +
  labs(title = "Depression search trends for states with high COVID cases has a normal distribution?", 
       x = "depression searches", 
       y = "number of states")
```
The outcomes within each group is not normal. The depression search trends for states with medium numbers of COVID cases and low numbers of COVID cases do not have a normal distribution, and n<30. Therefore, this assumption is not satisfied. By looking at the graphs, it also seems that there is not equal variance among each group, not satisfying the assumption of homoscedastic variance. In addition, these samples may not all be independent. Some states may have the same values/cultures as others, causing the people who live in each state to react to the virus similarly to each other and affecting the depression searches within those states. Because the assumptions for ANOVA is not satisfied, we decided to use the Kruskal-Wallis test despite the data not being independent.

```{r KW-test-depression-covid, echo = FALSE}
kruskal.test(depression ~ case_cat, data = trends)
```

The null is that there is no significant difference between the median depression trends of states with low COVID cases, medium COVID cases, and high COVID cases. The alternate hypothesis is that there exists at least one median that is different. Assuming the null hypothesis is true, the model follows a chi square distribution with a df of 2. The chi square statistic is 3.4137, and the corresponding p-value is 0.1814. Therefore, we can not reject the null under the alpha = 0.05 significance level. There is not enough evidence to suggest that there is at least one difference in median depression trends of states with low, medium, and high COVID cases.

## Association between "anxiety" searches and new COVID-19 cases per 100,000 residents in April 2020
```{r anxietyVScovid, echo = FALSE}
ggplot(trends, aes(New.COVID.cases.per.100.000.in.April, anxiety)) +
  geom_point(shape=1) +
   geom_smooth(method=lm) +
  labs(title = "More COVID cases assosciated with higher anxiety", 
       x = " New COVID-19 cases (per 100,000) ", 
       y = "Google searches for anxiety (relative to state)" )
```

The above scatterplot shows the relative google searches for anxiety among the 50 american states as a function of new COVID-19 cases per 100,000 during the month of april, 2020.
The line of best fit (in blue) has a positive slope. Thus, we can conclude that there's a correlation between anxiety searches and new COVID cases during the month of april. The more new COVID cases a state records, the higher anxiety searches it's expected to have. 

## COVID cases vs. anxiety rate
```{r covid-anxiety-assumptions, echo = FALSE}
ggplot(data = trends, mapping = aes(x = anxiety)) +
  geom_histogram(color = "darkgrey", fill = "lightcyan2", binwidth = 3)+
  facet_grid(case_cat~.) +
  labs(title = "Anxiety search trends for all levels of COVID cases do not have normal distributions", 
       x = "anxiety searches", 
       y = "number of states")
```
Looking at the graphs, outcomes within groups are not normally distributed for any level of COVID cases, so this assumption is not satisfied. It also looks like the within-group variance among all groups is not the same, so the assumption for homoscedastic variance is not satisfied. The samples are also not independent because states with similar values that live close to each other my have similar anxiety search trends. The assumptions for ANOVA are not satisfied. Therefore, we used the Kruskal-Wallis test.

```{r KW-test-anxiety-covid, echo = FALSE}
kruskal.test(anxiety ~ case_cat, data = trends)
```
The null is that there is no significant difference between the median anxiety trends of states with low COVID cases, medium COVID cases, and high COVID cases. The alternate hypothesis is that there exists at least one median that is different. Assuming the null hypothesis is true, the model follows a chi-square distribution with a df of 2. The chi square statistic is 7.425, and the corresponding p-value is 0.0242. Therefore, we can reject the null under the alpha = 0.05 significance level. There is  enough evidence to suggest that there is at least one difference in median anxiety trends of states with low, medium, and high COVID cases.

Since the overall Kruskal-Wallis test was significant, we then performed step down to identify where the differences are. The appropriate stepdown test is the Wilcox rank sum test. To account for multiple comparison, we will perform the Bonferroni correction and assess our results.

```{r covid-KW-stepdown}
low_covid <- trends %>% 
  filter(case_cat == "low") %>%
  select(anxiety) %>%
  pull()

med_covid <- trends %>% 
  filter(case_cat == "medium") %>%
  select(anxiety) %>% 
  pull()

high_covid <- trends %>% 
  filter(case_cat == "high") %>%
  select(anxiety) %>% 
  pull()

wilcox.test(low_covid, med_covid, data = licorice,
            alternative = "two.sided",
            paired = FALSE,
            conf.level = 0.95)
wilcox.test(low_covid, high_covid, data = licorice,
            alternative = "two.sided",
            paired = FALSE,
            conf.level = 0.95)
wilcox.test(med_covid, high_covid, data = licorice,
            alternative = "two.sided",
            paired = FALSE,
            conf.level = 0.95)
```
We find that the only pairwise difference in medians that is significant at the adjusted siginficance level is between medium COVID-19 case states and high COVID-19 case states. The null hypothesis for this test would be that there is no difference in the median anxiety searches of states with medium COVID-19 cases and high COVID-19 cases. The alternate hypothesis is there is a difference in the two medians. The p-value = 0.00672, and the adjusted significance level is alpha = 0.05/3 = 0.0167. We reject the null at the adjusted significance level, and conclude that there is enough evidence to suggest that there is a difference in median anxiety searches of states with medium COVID-19 cases and high COVID-19 cases.

# Question3: Does the level of restriction in US states have an effect on depression and anxiety levels?

## Restrictions vs. state depression trends
```{r restrictions-depression, echo = FALSE}
trends <- trends %>%
  mutate(restriction_cat = case_when(
    restriction <= 15 ~ "low",
    restriction >= 15 & restriction <= 33 ~ "medium",
    restriction > 33 ~ "high"
  ))
```

```{r restriction-depression-assumptions, echo = FALSE}
ggplot(data = trends, mapping = aes(x = depression)) +
  geom_histogram(color = "lavender", fill = "mediumpurple", binwidth = 3)+
  facet_grid(restriction_cat~.) +
  labs(title = "Depression search trends for states with high restrictions has a normal distribution", 
       x = "depression searches", 
       y = "number of states")
```
Looking at the graphs, outcomes within groups are not normally distributed for low and medium restriction level states, so this assumption is not satisfied. It also looks like the within-group variance among all groups is not the same, so the assumption for homoscedastic variance is not satisfied. The samples are also not independent because states with similar values that live close to each other may have similar anxiety search trends. The assumptions for ANOVA are not satisfied. We therefore decided to use the Kruskal-Wallis test.

```{r KW-test-restriction-depression, echo = FALSE}
kruskal.test(depression ~ restriction_cat, data = trends)
```
The null is that there is no significant difference between the median depression trends of states with low restrictions, medium restrictions, and high restrictions. The alternate hypothesis is that there exists at least one median that is different. Assuming the null hypothesis is true, the model follows a chi-square distribution with a df of 2. The chi-square statistic is 1.723 with a df = 2, and the corresponding p-value is 0.4225. Therefore, we can not reject the null under the alpha = 0.05 significance level. There is not enough evidence to suggest that there is at least one difference in median depression trends of states with low, medium, and high restrictions.

## Restrictions vs. state anxiety trends
```{r restriction-anxiety-assumptions, echo = FALSE}
ggplot(data = trends, mapping = aes(x = anxiety)) +
  geom_histogram(color = "cornsilk2", fill = "hotpink4", binwidth = 3)+
  facet_grid(restriction_cat~.) +
  labs(title = "anxiety search trends for all restriction levels do not have normal distributions", 
       x = "anxiety searches", 
       y = "number of states")
```
Looking at the graphs, outcomes within groups are not normally distributed for any level of COVID cases, so this assumption is not satisfied. It also looks like the within-group variance among all groups is not the same, so the assumption for homoscedastic variance is not satisfied. The samples are also not independent because states with similar values that live close to each other may have similar anxiety search trends. The assumptions for ANOVA are not satisfied. We therefore decide to use the Kruskal-Wallis test.

```{r KW-test-restriction-anxiety, echo = FALSE}
kruskal.test(anxiety ~ restriction_cat, data = trends)
```
The null is that there is no significant difference between the median anxiety trends of states with low restrictions, medium restrictions, and high restrictions. The alternate hypothesis is that there exists at least one median that is different. Assuming the null hypothesis is true, the model follows a chi square distribution with a df of 2. The chi square statistic is 12.719, and the corresponding p-value is 0.00173. Therefore, we reject the null under the alpha = 0.05 significance level. There is enough evidence to suggest that there is at least one difference in median anxiety trends of states with low, medium, and high restrictions.

Since the overall Kruskal-Wallis test was significant, we then performed step down to identify where the differences are. The appropriate stepdown test is the Wilcox rank sum test. To account for multiple comparison, we will perform the Bonferroni correction and assess our results.

```{r restriction-KW-stepdown}
low_rest <- trends %>% 
  filter(restriction_cat == "low") %>%
  select(anxiety) %>%
  pull()

med_rest <- trends %>% 
  filter(restriction_cat == "medium") %>%
  select(anxiety) %>% 
  pull()

high_rest <- trends %>% 
  filter(restriction_cat == "high") %>%
  select(anxiety) %>% 
  pull()

wilcox.test(low_rest, med_rest, data = trends,
            alternative = "two.sided",
            paired = FALSE,
            conf.level = 0.95)
wilcox.test(low_rest, high_rest, data = trends,
            alternative = "two.sided",
            paired = FALSE,
            conf.level = 0.95)
wilcox.test(med_rest, high_rest, data = trends,
            alternative = "two.sided",
            paired = FALSE,
            conf.level = 0.95)
```
We find that there are two pairwise differences in medians that is significant at the adjusted siginficance level: low restriction states and high restrictions staes, and medium restriction states vs. high restriction states. For the Wilcoxon rank sum test for low restriction vs. high restriction states, the p-value = 0.00213. With the adjusted significance level is alpha = 0.05/3 = 0.0167, we reject the null at the adjusted significance level, and conclude that there is enough evidence to suggest that there is a difference in median anxiety searches of states with low restrictions and high restrictions. Similarly, the Wilcoxon rank sum test for medium restriction vs. high restriction states had a p-value = 0.00239. We reject the null at the adjusted significance level alpha = 0.05/3, and conclude that there is enough evidence to suggest that there is a difference in median anxiety searches for medium restriction vs. high restriction states.

## Association between "anxiety" searches and restriction severity in April 2020
```{r anxietyVSrestrictions, echo = FALSE}
trends %>% 
  mutate( type=ifelse(restriction_cat=="high","Highlighted","Normal")) %>% ggplot( aes(x=restriction_cat, y=anxiety, fill=type, alpha=type)) + 
    geom_boxplot() +
    scale_fill_manual(values=c("#69b3a2", "grey")) +
    scale_alpha_manual(values=c(1,0.1)) +
    theme(legend.position = "none") +
    labs(title = "Higher restrictions associated with higher anxiety", 
       x = "Restrictions", 
       y = "Google searches for anxiety")
```

The above boxplot shows that the states with the highest COVID-related restrictions also record the highest google searches for anxiety compared to the states with low or moderate COVID-related restrictions. We notice that the highlighted box corresponding to the high restrictions states shows the highest median (approximately 87 compared to 78 and 79) and the highest maximum (approximately 97) and minimum (Approximately 76) upon excluding the extreme outliers in the medium group. 


## Association between "anxiety" searches and restriction severity in April 2020

```{r COVIDcaseVSanxiety}
trends %>% 
  mutate( type=ifelse(case_cat=="high","Highlighted","Normal")) %>% ggplot( aes(x=case_cat, y=anxiety, fill=type, alpha=type)) + 
    geom_boxplot() +
    scale_fill_manual(values=c("#69b3a2", "grey")) +
    scale_alpha_manual(values=c(1,0.1)) +
    theme(legend.position = "none") +
    labs(title = "More COVID-19 cases associated with higher anxiety", 
       x = "New COVID-19 cases per 100,000", 
       y = "Google searches for anxiety")
```
The above boxplot shows that the states with the highest COVID-19 new cases per 100,000 also record the highest google searches for anxiety compared to the states with low or moderate COVID-19 new cases. We notice that the highlighted box corresponding to the high number of new COVID-19 cases per 100,000 states shows the highest median (approximately 87 compared to approximately 79 in the low and medium groups) and the highest maximum (approximately 97) and minimum (Approximately 74) upon excluding the extreme outliers in the low group.


# Depression rate in each state map
```{r graph, echo = FALSE}
library(usmap)
library(ggplot2)

plot_usmap(data = dstate, values = "depression", color = "black") + 
  scale_fill_gradient(name = "depression searches", low = "azure1", high ="cadetblue4") +
  theme(legend.position = "right") +
  labs(title = "depression search trends in US states")
```


# Depression rate in each state map
```{r agraph, echo = FALSE}
plot_usmap(data = astate, values = "anxiety", color = "black") + 
  scale_fill_gradient(name = "anxiety searches", low = "azure1", high ="darkseagreen4") +
  theme(legend.position = "right") +
  labs(title = "anxiety search trends in US states")
```

  


 










